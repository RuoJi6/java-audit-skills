# 鉴权漏洞检查清单

## 目录

- [框架识别检查](#框架识别检查)
- [配置审计检查](#配置审计检查)
- [代码审计检查](#代码审计检查)
- [漏洞检测检查](#漏洞检测检查)
- [输出验证检查](#输出验证检查)

---

## 框架识别检查

### 鉴权框架识别

- [ ] **Shiro**
  - [ ] 检查 `shiro.ini` 文件
  - [ ] 检查 `shiro-spring.xml` 配置
  - [ ] 搜索 `@RequiresAuthentication` 等注解
  - [ ] 搜索 `SecurityUtils.getSubject()` 调用

- [ ] **Spring Security**
  - [ ] 检查 `@EnableWebSecurity` 注解
  - [ ] 检查 `SecurityFilterChain` Bean
  - [ ] 搜索 `@PreAuthorize` 等注解
  - [ ] 检查 `WebSecurityConfigurerAdapter` 实现

- [ ] **JWT**
  - [ ] 检查 `io.jsonwebtoken` 依赖
  - [ ] 搜索 `Jwts.builder()` 调用
  - [ ] 搜索 `Authorization: Bearer` 处理

- [ ] **Filter/Interceptor**
  - [ ] 检查 `web.xml` Filter 配置
  - [ ] 搜索 `implements Filter` 类
  - [ ] 搜索 `implements HandlerInterceptor` 类

- [ ] **自定义鉴权**
  - [ ] 搜索自定义权限注解
  - [ ] 搜索 AOP 切面处理

### 版本检查

- [ ] 检查 Shiro 版本（< 1.10.0 有已知漏洞）
- [ ] 检查 Spring Security 版本
- [ ] 检查 JWT 库版本

---

## 配置审计检查

### Shiro 配置

- [ ] filterChainDefinitionMap 顺序是否正确
- [ ] 是否有默认拒绝规则 (`/** = authc`)
- [ ] anon 路径是否过宽
- [ ] RememberMe 密钥是否为默认值
- [ ] Session 超时配置是否合理

### Spring Security 配置

- [ ] 路径匹配器类型（antMatchers vs mvcMatchers）
- [ ] 规则顺序是否正确
- [ ] 是否有 `anyRequest().authenticated()`
- [ ] CSRF 配置是否合理
- [ ] CORS 配置是否过于宽松
- [ ] Session 管理配置

### JWT 配置

- [ ] 密钥是否硬编码
- [ ] 密钥强度是否足够
- [ ] 过期时间是否合理
- [ ] 是否有 Token 吊销机制

### Filter/Interceptor 配置

- [ ] url-pattern 覆盖范围是否完整
- [ ] 白名单路径是否过宽
- [ ] Filter/Interceptor 执行顺序

### Cookie/Session 配置

- [ ] HttpOnly 是否启用
- [ ] Secure 是否启用
- [ ] SameSite 是否配置
- [ ] Session 超时时间

---

## 代码审计检查

### 鉴权逻辑

- [ ] 是否有默认拒绝逻辑
- [ ] 异常情况下是否放行
- [ ] 是否验证用户角色/权限
- [ ] 是否验证用户状态（禁用/删除）

### 路径匹配

- [ ] 匹配算法是否安全（避免 startsWith/contains）
- [ ] 是否处理 URL 编码
- [ ] 是否处理路径穿越
- [ ] 是否处理大小写
- [ ] 是否处理特殊字符（分号、空字节）

### Session 管理

- [ ] 登录后是否更换 Session ID
- [ ] 登出时是否销毁 Session
- [ ] Session 中是否存储敏感信息

### 密码安全

- [ ] 密码是否加密存储
- [ ] 是否使用安全的哈希算法
- [ ] 是否有密码策略

### 权限校验

- [ ] 敏感接口是否都有权限注解
- [ ] 是否存在水平越权风险
- [ ] 是否存在垂直越权风险

---

## 漏洞检测检查

### 路径绕过测试

- [ ] 路径穿越 (`/../`, `/./`)
- [ ] 双斜杠 (`//`)
- [ ] 尾部斜杠 (`/admin/`)
- [ ] 大小写 (`/Admin`, `/ADMIN`)
- [ ] 分号参数 (`/admin;`)
- [ ] URL 编码 (`/%61dmin`)
- [ ] 双重编码 (`/%2561dmin`)
- [ ] 空字节 (`/admin%00`)

### 参数绕过测试

- [ ] 参数覆盖 (`role=admin`)
- [ ] 参数污染 (`role=user&role=admin`)
- [ ] 隐藏参数 (`isAdmin=true`)

### HTTP 方法测试

- [ ] 方法切换 (GET/POST/PUT/DELETE)
- [ ] 方法覆盖 (X-HTTP-Method-Override)

### 框架特定测试

- [ ] Shiro CVE 漏洞
- [ ] Spring Security 配置问题
- [ ] JWT 算法攻击

### 越权测试

- [ ] 水平越权（访问其他用户数据）
- [ ] 垂直越权（普通用户访问管理功能）

---

## 输出验证检查

### 报告完整性

- [ ] 所有鉴权框架已识别
- [ ] 所有配置已分析
- [ ] 所有路由已标注鉴权状态
- [ ] 所有漏洞已记录

### 风险分类

- [ ] 高危风险已标注
- [ ] 中危风险已标注
- [ ] 低危风险已标注

### PoC 验证

- [ ] 每个高危漏洞有验证 PoC
- [ ] PoC 格式正确（HTTP 请求）
- [ ] PoC 可直接用于测试

### 修复建议

- [ ] 每个漏洞有修复建议
- [ ] 建议具体可操作
- [ ] 建议符合安全最佳实践

---

## 快速检查模板

### 审计开始前

```markdown
## 项目信息
- 项目名称: 
- 项目路径: 
- 分析时间: 

## 框架识别结果
- [ ] Shiro: 
- [ ] Spring Security: 
- [ ] JWT: 
- [ ] Filter: 
- [ ] Interceptor: 

## 需要反编译的类
- [ ] 
- [ ] 
```

### 审计进行中

```markdown
## 配置分析进度
- [ ] 鉴权配置文件
- [ ] 路径-权限映射
- [ ] Session 配置
- [ ] Cookie 配置

## 代码分析进度
- [ ] Filter 类
- [ ] Interceptor 类
- [ ] 权限注解
- [ ] 登录/登出逻辑

## 漏洞检测进度
- [ ] 路径绕过测试
- [ ] 参数绕过测试
- [ ] 越权测试
```

### 审计完成后

```markdown
## 审计结果汇总
- 高危漏洞: X 个
- 中危漏洞: X 个
- 低危漏洞: X 个

## 文件输出
- [ ] 主报告已生成
- [ ] 路由映射表已生成
- [ ] README 已生成

## 验证确认
- [ ] 所有 PoC 已验证
- [ ] 修复建议已确认
```

---

## 风险等级定义

| 等级 | 描述 | 示例 |
|------|------|------|
| **高危** | 可直接导致未授权访问或数据泄露 | 鉴权绕过、未授权访问管理接口 |
| **中危** | 需要特定条件才能利用 | 越权访问、Session 配置问题 |
| **低危** | 影响有限或难以利用 | 信息泄露、配置不当 |

---

## 常见漏洞速查

| 漏洞类型 | 检测方法 | 风险等级 |
|----------|----------|----------|
| 未授权访问 | 接口无鉴权保护 | 高 |
| 鉴权绕过 | 路径/参数/方法绕过 | 高 |
| 水平越权 | 访问其他用户数据 | 高 |
| 垂直越权 | 普通用户访问管理功能 | 高 |
| Session 固定 | 登录前后 Session ID 不变 | 中 |
| CSRF | 缺少 CSRF 保护 | 中 |
| JWT 密钥弱 | 密钥可被暴力破解 | 中 |
| Cookie 不安全 | 缺少 HttpOnly/Secure | 中 |
| 密码明文存储 | 数据库中密码未加密 | 高 |
| 默认密钥 | 使用框架默认密钥 | 高 |

---

## 输出模板

```markdown
# {项目名称} - 鉴权审计报告

## 审计概要

| 项目 | 内容 |
|------|------|
| 项目名称 | {name} |
| 审计时间 | {timestamp} |
| 鉴权框架 | {frameworks} |
| 路由总数 | {route_count} |

## 风险统计

| 风险等级 | 数量 |
|----------|------|
| 高危 | {high_count} |
| 中危 | {medium_count} |
| 低危 | {low_count} |

## 漏洞详情

### 高危漏洞

=== [AUTH-001] {漏洞标题} ===
风险等级: 高
位置: {location}
路由: {route}

问题描述:
- {description}

验证 PoC:
\```http
{poc}
\```

建议修复:
- {fix}

---

## 路由-鉴权映射

| 路由 | 方法 | 鉴权状态 | 风险 |
|------|------|----------|------|
| {route} | {method} | {status} | {risk} |

---

## 审计结论

{conclusion}

## 修复优先级

1. {high_priority_fixes}
2. {medium_priority_fixes}
3. {low_priority_fixes}
```
